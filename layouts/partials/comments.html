<div class="giscus"></div>

<script>
    // 1. PaperModの「記憶」を直接読み取ってテーマを決める関数
    function getGiscusTheme() {
        // ブラウザに保存されたPaperModの設定を見る
        const localTheme = localStorage.getItem("pref-theme");
        
        // 設定が「dark」なら迷わずdark
        if (localTheme === "dark") return "dark";
        // 設定が「light」なら迷わずlight
        if (localTheme === "light") return "light";
        
        // 設定がない（自動）場合は、OSの設定を見る
        return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }

    // 2. 設定
    const giscusConfig = {
        repo: "shidowister/ist-md-pc-club-site",
        repoId: "R_kgDOQg0ojg",
        category: "General",
        categoryId: "DIC_kwDOQg0ojs4C0htG",
        mapping: "title",
        reactionsEnabled: "1",
        emitMetadata: "0",
        inputPosition: "bottom",
        lang: "ja",
    };

    // 3. Giscusの読み込み（ローカルストレージの判定結果を使う）
    const giscusScript = document.createElement("script");
    giscusScript.src = "https://giscus.app/client.js";
    giscusScript.setAttribute("data-repo", giscusConfig.repo);
    giscusScript.setAttribute("data-repo-id", giscusConfig.repoId);
    giscusScript.setAttribute("data-category", giscusConfig.category);
    giscusScript.setAttribute("data-category-id", giscusConfig.categoryId);
    giscusScript.setAttribute("data-mapping", giscusConfig.mapping);
    giscusScript.setAttribute("data-reactions-enabled", giscusConfig.reactionsEnabled);
    giscusScript.setAttribute("data-emit-metadata", giscusConfig.emitMetadata);
    giscusScript.setAttribute("data-input-position", giscusConfig.inputPosition);
    giscusScript.setAttribute("data-lang", giscusConfig.lang);
    
    // ★ここが修正点：画面のクラスではなく、保存された設定を使う
    giscusScript.setAttribute("data-theme", getGiscusTheme());
    
    giscusScript.crossOrigin = "anonymous";
    giscusScript.async = true;
    document.querySelector(".giscus").appendChild(giscusScript);

    // 4. 切り替えボタンが押された時の動作（変更の監視）
    const observer = new MutationObserver(function() {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        
        // 切り替え時はbodyのクラスを見るのが一番確実（ボタン押下後はクラスが変わるため）
        const isDark = document.body.classList.contains('dark');
        const newTheme = isDark ? 'dark' : 'light';
        
        iframe.contentWindow.postMessage({
            giscus: {
                setConfig: {
                    theme: newTheme
                }
            }
        }, 'https://giscus.app');
    });
    
    // bodyタグのクラス変更を監視スタート
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
</script>